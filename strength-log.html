<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Strength Log</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Add Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- SAFE SIMPLE ICON (Emoji based to prevent spam flagging) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ª</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23111827%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ðŸ’ª</text></svg>">
    
    <style>
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Gray 900 */
            color: #f3f4f6; /* Gray 100 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Scrollbar hiding */
        ::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            height: 100vh; /* Fallback */
            height: -webkit-fill-available;
        }

        /* Custom Inputs for "Fat Finger" usage */
        .big-input {
            font-size: 1.5rem;
            text-align: center;
            appearance: none;
            -moz-appearance: textfield;
        }
        .big-input::-webkit-outer-spin-button,
        .big-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 20px;
            border-radius: 16px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Rest Timer Overlay */
        #rest-timer-overlay {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 80px); /* Above footer */
            right: 20px;
            background-color: #374151;
            border: 1px solid #4b5563;
            padding: 10px 15px;
            border-radius: 50px;
            display: none;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 40;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Loader */
        .loader {
            border: 3px solid #374151;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Checkbox for Routines */
        .routine-check:checked + div {
            text-decoration: line-through;
            color: #6b7280;
        }
        .routine-check:checked + div + div i {
            color: #22c55e;
            opacity: 1;
        }
        
        /* Expandable Details */
        .routine-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #374151;
        }
        .routine-details.open {
            display: block;
            animation: fadeIn 0.2s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #6b7280;
            background-color: #374151;
        }
        .calendar-day.active {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        .calendar-day.today {
            border: 1px solid #60a5fa;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen flex flex-col items-center justify-center p-8">
        <div class="loader" style="width: 40px; height: 40px;"></div>
        <h1 class="text-xl font-semibold mt-4 text-blue-400">Strength Log</h1>
        <p id="auth-status" class="text-gray-500 text-sm mt-2">Initializing...</p>
    </div>

    <!-- Home Screen -->
    <div id="homeScreen" class="screen flex-col p-6">
        <header class="text-center mt-8 mb-8 relative">
            <div class="inline-block p-3 rounded-full bg-blue-900/30 mb-3">
                <i class="ph ph-barbell text-3xl text-blue-400"></i>
            </div>
            <h1 class="text-3xl font-bold tracking-tight">Strength Log</h1>
            <button onclick="showSettings()" class="absolute top-0 right-0 text-gray-500 hover:text-white p-2">
                <i class="ph ph-gear text-xl"></i>
            </button>
        </header>
        
        <div class="flex-grow space-y-4">
            <button onclick="startFlow('A')" class="group relative w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 p-6 rounded-2xl text-left transition-all active:scale-95 shadow-lg">
                <div class="absolute top-6 right-6 text-gray-600 group-hover:text-blue-400">
                    <i class="ph ph-arrow-right text-2xl"></i>
                </div>
                <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">Workout A</span>
                <span class="block text-2xl font-bold text-white mt-1">Squat & Bench</span>
                <span class="block text-sm text-gray-400 mt-2">Barbell Bench, Goblet Squat, Rows + 3 more</span>
            </button>

            <button onclick="startFlow('B')" class="group relative w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 p-6 rounded-2xl text-left transition-all active:scale-95 shadow-lg">
                <div class="absolute top-6 right-6 text-gray-600 group-hover:text-green-400">
                    <i class="ph ph-arrow-right text-2xl"></i>
                </div>
                <span class="text-xs font-bold text-green-400 uppercase tracking-wider">Workout B</span>
                <span class="block text-2xl font-bold text-white mt-1">Deadlift & Press</span>
                <span class="block text-sm text-gray-400 mt-2">Trap Bar DL, Lat Pulldown, Press + 3 more</span>
            </button>
            
            <!-- TRENDS BUTTON -->
            <button onclick="showTrends()" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 text-blue-400 p-4 rounded-xl mt-6 flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg">
                <i class="ph ph-chart-line-up text-xl"></i>
                <span class="font-semibold">Progress Trends</span>
            </button>

            <!-- GEMINI BUTTON -->
            <button id="get-analysis-btn" class="w-full bg-purple-600/20 hover:bg-purple-600/30 border border-purple-500/30 text-purple-300 p-4 rounded-xl mt-2 flex items-center justify-center gap-2 transition-all active:scale-95">
                <i class="ph ph-magic-wand text-xl"></i>
                <span class="font-semibold">AI Coach Analysis</span>
            </button>
        </div>
    </div>

    <!-- Trends Screen (New) -->
    <div id="trendsScreen" class="screen flex-col bg-gray-900">
        <header class="p-6 border-b border-gray-800 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-white">Trends</h2>
                <p class="text-sm text-gray-400">Consistency & Progress</p>
            </div>
            <button onclick="showHomeScreen()" class="text-gray-400 hover:text-white"><i class="ph ph-x text-2xl"></i></button>
        </header>
        <main class="flex-grow p-4 overflow-y-auto space-y-6">
            <!-- Calendar Heatmap -->
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="flex justify-between items-baseline mb-2">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wide">Sessions (This Month)</h3>
                    <span id="monthly-count" class="text-sm font-bold text-blue-400">0</span>
                </div>
                <div id="calendar-container" class="calendar-grid"></div>
            </div>

            <!-- Line Chart -->
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 min-h-[380px]">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wide mb-4">Max Weight Progression</h3>
                
                <!-- Exercise Selector -->
                <div class="mb-4">
                    <select id="chart-exercise-select" onchange="updateChart()" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500">
                        <!-- Options injected via JS -->
                    </select>
                </div>

                <div class="relative h-64 w-full">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Routine Screen (Warmup/Cooldown) -->
    <div id="routineScreen" class="screen flex-col bg-gray-900">
        <header class="p-6 border-b border-gray-800">
            <h2 id="routine-title" class="text-2xl font-bold text-white">Warm Up</h2>
            <p id="routine-subtitle" class="text-sm text-gray-400">Get ready to move</p>
        </header>
        <main class="flex-grow p-6 overflow-y-auto">
            <div id="routine-list" class="space-y-3">
                <!-- Items injected here -->
            </div>
        </main>
        <footer class="p-6 border-t border-gray-800 bg-gray-900">
            <button id="routine-action-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white h-14 rounded-xl font-bold text-lg shadow-lg active:scale-[0.98] transition-transform">
                Start Workout
            </button>
            <button onclick="skipRoutine()" class="w-full text-gray-500 text-sm mt-4 font-medium hover:text-white">
                Skip this step
            </button>
        </footer>
    </div>

    <!-- Workout Screen -->
    <div id="workoutScreen" class="screen flex-col bg-gray-900">
        <!-- Top Bar -->
        <header class="sticky top-0 bg-gray-900/95 backdrop-blur border-b border-gray-800 z-20 px-4 py-3 flex items-center justify-between">
            <button onclick="showHomeScreen()" class="p-2 -ml-2 text-gray-400 hover:text-white">
                <i class="ph ph-x text-xl"></i>
            </button>
            <div class="text-center">
                <h2 id="exercise-counter" class="text-xs font-bold text-blue-400 tracking-wide">EXERCISE 1/6</h2>
            </div>
            <button onclick="showGuidance()" class="p-2 -mr-2 text-gray-400 hover:text-white">
                <i class="ph ph-info text-xl"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-grow overflow-y-auto p-4 pb-32">
            
            <!-- Exercise Title -->
            <div class="text-center mb-6 mt-2">
                <h1 id="exercise-name" class="text-2xl font-bold text-white leading-tight">Barbell Bench Press</h1>
                <div id="last-log-display" class="text-sm text-gray-400 mt-1 h-5">Loading history...</div>
            </div>

            <!-- Input Area -->
            <div class="bg-gray-800 rounded-2xl p-5 shadow-lg border border-gray-700">
                <div class="flex gap-4 mb-6">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 text-center">Weight (kg)</label>
                        <div class="flex items-center">
                            <button onclick="adjustWeight(-1.25)" class="w-10 h-12 bg-gray-700 rounded-l-lg text-gray-400 active:bg-gray-600 border-r border-gray-600">-</button>
                            <input type="number" id="weight-input" class="big-input w-full h-12 bg-gray-900 text-white border-y border-gray-600 focus:outline-none focus:border-blue-500" placeholder="0">
                            <button onclick="adjustWeight(1.25)" class="w-10 h-12 bg-gray-700 rounded-r-lg text-gray-400 active:bg-gray-600 border-l border-gray-600">+</button>
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 text-center">Reps</label>
                        <div class="flex items-center">
                            <button onclick="adjustReps(-1)" class="w-10 h-12 bg-gray-700 rounded-l-lg text-gray-400 active:bg-gray-600 border-r border-gray-600">-</button>
                            <input type="number" id="reps-input" class="big-input w-full h-12 bg-gray-900 text-white border-y border-gray-600 focus:outline-none focus:border-blue-500" placeholder="0">
                            <button onclick="adjustReps(1)" class="w-10 h-12 bg-gray-700 rounded-r-lg text-gray-400 active:bg-gray-600 border-l border-gray-600">+</button>
                        </div>
                    </div>
                </div>

                <!-- RPE Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">RPE (Exertion)</label>
                        <span id="rpe-value" class="text-xs font-bold text-blue-400">8</span>
                    </div>
                    <input type="range" id="rpe-input" min="1" max="10" value="8" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                        <span>Easy</span>
                        <span>Hard</span>
                        <span>Max</span>
                    </div>
                </div>

                <button onclick="logSet()" class="w-full bg-blue-600 hover:bg-blue-500 text-white h-14 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/30 active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
                    <i class="ph ph-check-circle text-2xl"></i>
                    LOG SET
                </button>
            </div>

            <!-- Today's History -->
            <div id="todays-sets-list" class="mt-6 space-y-2">
                <!-- Sets go here -->
            </div>

        </main>

        <!-- Bottom Nav -->
        <footer class="fixed bottom-0 w-full bg-gray-900 border-t border-gray-800 p-4 pb-8 z-20 flex justify-between items-center">
            <button onclick="changeExercise(-1)" id="prev-exercise-btn" class="w-12 h-12 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center active:bg-gray-700 disabled:opacity-30">
                <i class="ph ph-caret-left text-2xl"></i>
            </button>
            
            <div class="flex flex-col items-center">
                <!-- Progress dots could go here -->
            </div>

            <button onclick="changeExercise(1)" id="next-exercise-btn" class="h-12 px-6 rounded-full bg-gray-800 text-white font-semibold flex items-center gap-2 active:bg-gray-700">
                Next
                <i class="ph ph-caret-right text-lg"></i>
            </button>
        </footer>

        <!-- Floating Rest Timer -->
        <div id="rest-timer-overlay">
            <i class="ph ph-timer text-blue-400 text-xl mr-2"></i>
            <span id="rest-timer-display" class="font-mono text-xl font-bold text-white w-12">01:30</span>
            <button onclick="addRestTime(30)" class="ml-3 text-xs bg-gray-600 px-2 py-1 rounded hover:bg-gray-500">+30s</button>
            <button onclick="stopRestTimer()" class="ml-2 text-gray-400 hover:text-white">
                <i class="ph ph-x"></i>
            </button>
        </div>
    </div>

    <!-- Guidance Modal -->
    <div id="guidanceModal" class="modal" onclick="hideModal('guidanceModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h3 id="guidance-title" class="text-xl font-bold text-white"></h3>
                <button onclick="hideModal('guidanceModal')" class="text-gray-400"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <ol id="guidance-list" class="list-decimal list-inside space-y-3 text-gray-300 text-sm leading-relaxed mb-6"></ol>
            
            <button id="get-cues-btn" class="w-full bg-blue-900/30 border border-blue-500/30 text-blue-300 p-3 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold">
                <i class="ph ph-sparkle"></i> Get Form Cues
            </button>
            <div id="gemini-cues-container" class="mt-4 hidden">
                <div id="gemini-cues-loader" class="flex items-center justify-center text-gray-400 text-sm"><div class="loader w-4 h-4 border-2 mr-2"></div> Thinking...</div>
                <ul id="gemini-cues-list" class="list-disc list-inside space-y-2 text-blue-200 text-sm mt-2"></ul>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="modal" onclick="hideModal('analysisModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-white">Progress Analysis</h3>
                <button onclick="hideModal('analysisModal')" class="text-gray-400"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <div id="analysis-loader" class="flex flex-col items-center py-8">
                <div class="loader"></div>
                <p class="mt-3 text-sm text-gray-400">Gemini is studying your logs...</p>
            </div>
            <div id="analysis-content" class="text-sm text-gray-300 leading-relaxed space-y-4"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" onclick="hideModal('settingsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-white">Settings</h3>
                <button onclick="hideModal('settingsModal')" class="text-gray-400"><i class="ph ph-x text-2xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Gemini API Key</label>
                    <input type="password" id="settings-api-key" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500" placeholder="Paste your API key here">
                    <p class="text-xs text-gray-500 mt-2">Required for AI analysis features. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">Get one here</a>.</p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold mt-4">Save Settings</button>
                <button onclick="exportData()" class="w-full border border-gray-600 text-gray-300 p-3 rounded-lg font-bold mt-2 text-sm">Export Data (JSON)</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal" style="z-index: 60;">
        <div class="modal-content text-center" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-white mb-2">Notice</h3>
            <p id="alert-message" class="text-gray-400 mb-6"></p>
            <button onclick="hideAlert()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">OK</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal" style="z-index: 60;">
        <div class="modal-content text-center" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-white mb-2">Confirm</h3>
            <p id="confirm-message" class="text-gray-400 mb-6"></p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 bg-gray-700 text-white p-3 rounded-lg font-bold">Cancel</button>
                <button id="confirm-ok" class="flex-1 bg-red-600 text-white p-3 rounded-lg font-bold">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const workouts = {
            A: [
                { id: 'benchPress', name: 'Barbell Bench Press', type: 'barbell', targetSets: 3, targetReps: '6-10', guidance: ["<b>Setup:</b> 5 Points of Contact (Head, Upper Back, Glutes, Feet).", "<b>Grip:</b> Wider than shoulder-width.", "<b>Arch:</b> Squeeze shoulder blades into back pockets.", "<b>Press:</b> Drive feet into floor, push body away from bar."] },
                { id: 'gobletSquat', name: 'Goblet Squat', type: 'dumbbell', targetSets: 3, targetReps: '8-12', guidance: ["<b>Setup:</b> Cup dumbbell at chest.", "<b>Brace:</b> Deep breath, tight core.", "<b>Descent:</b> Chest up, elbows between knees.", "<b>Depth:</b> Hips parallel to knees."] },
                { id: 'dbRow', name: 'Single-Arm DB Row', type: 'dumbbell', targetSets: 3, targetReps: '10-12', guidance: ["<b>Setup:</b> Knee/Hand on bench, flat back.", "<b>Pull:</b> Elbow to ceiling, toward hip.", "<b>Squeeze:</b> Feel the lat contract.", "<b>Return:</b> Controlled stretch."] },
                { id: 'dbRdl', name: 'Dumbbell RDL', type: 'dumbbell', targetSets: 3, targetReps: '8-12', guidance: ["<b>Hinge:</b> Push hips BACK, soft knees.", "<b>Path:</b> Keep DBs scraping thighs.", "<b>Depth:</b> Until hamstrings stretch (usually mid-shin).", "<b>Up:</b> Squeeze glutes to stand."] },
                { id: 'bicepCurls', name: 'Bicep Curls', type: 'dumbbell', targetSets: 3, targetReps: '10-15', guidance: ["<b>Elbows:</b> Pinned to ribs.", "<b>Squeeze:</b> At the top.", "<b>Control:</b> Slow descent."] },
                { id: 'tricepPushdown', name: 'Tricep Pushdown', type: 'cable', targetSets: 3, targetReps: '12-15', guidance: ["<b>Stance:</b> Slight lean forward.", "<b>Elbows:</b> Locked at sides.", "<b>Push:</b> Spread rope at bottom."] }
            ],
            B: [
                { id: 'trapBarDeadlift', name: 'Trap Bar Deadlift', type: 'barbell', targetSets: 3, targetReps: '5-8', guidance: ["<b>Setup:</b> Feet hip-width inside bar.", "<b>Wedge:</b> Chest up, hips down, pull slack.", "<b>Drive:</b> Push floor away.", "<b>Lockout:</b> Tall glute squeeze."] },
                { id: 'latPulldown', name: 'Lat Pulldown', type: 'cable', targetSets: 3, targetReps: '10-15', guidance: ["<b>Grip:</b> Wide.", "<b>Pull:</b> Elbows down to back pockets.", "<b>Chest:</b> Proud/Up.", "<b>Stretch:</b> Full reach at top."] },
                { id: 'seatedDbPress', name: 'Seated DB Press', type: 'dumbbell', targetSets: 3, targetReps: '8-12', guidance: ["<b>Bench:</b> High incline.", "<b>Brace:</b> Ribs down, core tight.", "<b>Press:</b> Biceps to ears."] },
                { id: 'stepUps', name: 'Step-Ups', type: 'bodyweight', targetSets: 3, targetReps: '10-12', guidance: ["<b>Plant:</b> Full foot on box.", "<b>Drive:</b> Through front heel only.", "<b>Control:</b> Slow descent."] },
                { id: 'lateralRaises', name: 'Lateral Raises', type: 'dumbbell', targetSets: 3, targetReps: '12-20', guidance: ["<b>Lead:</b> With elbows.", "<b>Height:</b> Shoulder level.", "<b>Control:</b> No swinging."] },
                { id: 'plank', name: 'Plank', type: 'bodyweight', targetSets: 3, targetReps: '45-60s', guidance: ["<b>Line:</b> Straight head to heels.", "<b>Glutes:</b> Squeezed hard.", "<b>Abs:</b> Brace against punch."] }
            ]
        };

        const routines = {
            A: {
                warmup: [
                    { name: "Thoracic Rotations", reps: "10/side", note: "Mobilise upper back", image: "https://placehold.co/600x400/374151/FFF?text=Thoracic+Rotations", steps: ["Start on all fours.", "Hand behind head.", "Rotate elbow down to opp arm.", "Rotate elbow up to ceiling."] },
                    { name: "90/90 Hip Switch", reps: "10 reps", note: "Oil hips for squat", image: "https://placehold.co/600x400/374151/FFF?text=90/90+Hip+Switch", steps: ["Sit with legs bent 90 degrees.", "Rotate knees side to side.", "Keep heels on floor."] },
                    { name: "Rear Delt Activation", reps: "15 reps", note: "Band Pull-Apart OR Reverse Fly", image: "https://placehold.co/600x400/374151/FFF?text=Rear+Delts", customContent: `<div class="mb-2"><strong class="text-blue-400">Option A: Band Pull-Apart</strong></div><ol class="list-decimal list-inside text-sm text-gray-300 space-y-1 pl-2 mb-4"><li>Hold band, arms straight.</li><li>Pull apart to chest.</li></ol><div class="mb-2"><strong class="text-blue-400">Option B: Reverse Fly</strong></div><ol class="list-decimal list-inside text-sm text-gray-300 space-y-1 pl-2"><li>Hinge forward.</li><li>Raise light weights to side.</li></ol>` }
                ],
                cooldown: [
                    { name: "Doorway Chest Stretch", reps: "30s/side", note: "Open pecs", image: "https://placehold.co/600x400/374151/FFF?text=Chest+Stretch", steps: ["Forearm on door frame.", "Step forward gently."] },
                    { name: "Couch Stretch", reps: "45s/side", note: "Quad release", image: "https://placehold.co/600x400/374151/FFF?text=Couch+Stretch", steps: ["Knee near wall.", "Other foot lunge forward.", "Squeeze glute."] }
                ]
            },
            B: {
                warmup: [
                    { name: "World's Greatest Stretch", reps: "5/side", note: "Hips & Spine", image: "https://placehold.co/600x400/374151/FFF?text=Worlds+Greatest", steps: ["Lunge forward.", "Opposite hand down.", "Rotate chest up."] },
                    { name: "Glute Bridges", reps: "15 reps", note: "Wake up glutes", image: "https://placehold.co/600x400/374151/FFF?text=Glute+Bridges", steps: ["Lie on back.", "Lift hips high.", "Squeeze glutes."] },
                    { name: "Deadbugs", reps: "10 reps", note: "Core bracing", image: "https://placehold.co/600x400/374151/FFF?text=Deadbugs", steps: ["Back flat on floor.", "Extend opp arm/leg.", "Keep core tight."] }
                ],
                cooldown: [
                    { name: "Child's Pose", reps: "60s", note: "Decompress", image: "https://placehold.co/600x400/374151/FFF?text=Childs+Pose", steps: ["Kneel wide.", "Sit back on heels.", "Reach arms forward."] },
                    { name: "Seated Hamstring", reps: "45s", note: "Posterior chain", image: "https://placehold.co/600x400/374151/FFF?text=Seated+Hamstring", steps: ["Legs straight.", "Reach for toes.", "Keep back straight."] }
                ]
            }
        };

        let currentWorkoutType = 'A';
        let currentExerciseIndex = 0;
        let currentSessionLogs = {};
        let timerInterval;
        let restTimeRemaining = 0;
        let confirmResolve = null;
        let currentRoutineMode = null;
        let progressChart = null;

        // --- LOCAL DB CLASS (Replaces Firebase) ---
        const LocalDB = {
            getAllLogs: () => {
                const logs = localStorage.getItem('strength_logs');
                return logs ? JSON.parse(logs) : [];
            },
            addLog: (log) => {
                const logs = LocalDB.getAllLogs();
                logs.push({ ...log, timestamp: new Date().toISOString() }); 
                localStorage.setItem('strength_logs', JSON.stringify(logs));
            },
            getLogsByExercise: (id) => {
                const logs = LocalDB.getAllLogs();
                return logs.filter(l => l.exerciseId === id);
            },
            getApiKey: () => localStorage.getItem('gemini_api_key') || ''
        };

        // --- UI HELPERS ---
        window.showModal = (id) => { document.getElementById(id).style.display = 'flex'; }
        window.hideModal = (id) => { document.getElementById(id).style.display = 'none'; }
        
        window.showAlert = (message) => {
            document.getElementById('alert-message').textContent = message;
            window.showModal('alertModal');
        }
        
        window.hideAlert = () => {
            window.hideModal('alertModal');
        }

        window.showCustomConfirm = (msg) => {
            return new Promise((resolve) => {
                confirmResolve = resolve;
                document.getElementById('confirm-message').textContent = msg;
                window.showModal('confirmModal');
            });
        }

        // --- SETTINGS ---
        window.showSettings = () => {
            document.getElementById('settings-api-key').value = LocalDB.getApiKey();
            window.showModal('settingsModal');
        }

        window.saveSettings = () => {
            const key = document.getElementById('settings-api-key').value.trim();
            localStorage.setItem('gemini_api_key', key);
            window.hideModal('settingsModal');
            window.showAlert("Settings saved.");
        }

        window.exportData = () => {
            const data = JSON.stringify(LocalDB.getAllLogs(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'strength_logs.json';
            a.click();
        }

        // --- INPUT HANDLERS ---
        window.adjustWeight = (delta) => {
            const input = document.getElementById('weight-input');
            let val = parseFloat(input.value) || 0;
            val += delta;
            if (val < 0) val = 0;
            input.value = val;
        }

        window.adjustReps = (delta) => {
            const input = document.getElementById('reps-input');
            let val = parseInt(input.value) || 0;
            val += delta;
            if (val < 0) val = 0;
            input.value = val;
        }
        
        document.getElementById('rpe-input').addEventListener('input', (e) => {
            document.getElementById('rpe-value').textContent = e.target.value;
        });

        // --- TIMER LOGIC ---
        window.startRestTimer = () => {
            clearInterval(timerInterval);
            restTimeRemaining = 90;
            const display = document.getElementById('rest-timer-display');
            const overlay = document.getElementById('rest-timer-overlay');
            
            overlay.style.display = 'flex';
            
            function tick() {
                restTimeRemaining--;
                if (restTimeRemaining < 0) {
                    clearInterval(timerInterval);
                    if(navigator.vibrate) navigator.vibrate(200);
                    overlay.style.display = 'none';
                    return;
                }
                
                const m = Math.floor(restTimeRemaining / 60);
                const s = restTimeRemaining % 60;
                display.textContent = `${m}:${s.toString().padStart(2, '0')}`;
            }
            
            const m = Math.floor(restTimeRemaining / 60);
            const s = restTimeRemaining % 60;
            display.textContent = `${m}:${s.toString().padStart(2, '0')}`;
            
            timerInterval = setInterval(tick, 1000);
        }

        window.addRestTime = (seconds) => { restTimeRemaining += seconds; }
        window.stopRestTimer = () => {
            clearInterval(timerInterval);
            document.getElementById('rest-timer-overlay').style.display = 'none';
        }

        // --- APP FLOW CONTROL ---
        window.startFlow = async (type) => {
            currentWorkoutType = type;
            const doWarmup = await window.showCustomConfirm(`Start with Warm-up for Workout ${type}?`);
            
            document.getElementById('homeScreen').style.display = 'none';
            if (doWarmup) {
                renderRoutine('warmup');
            } else {
                window.startWorkout();
            }
        }

        window.toggleRoutineDetails = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('open');
        }

        function renderRoutine(mode) {
            currentRoutineMode = mode;
            const routineData = routines[currentWorkoutType][mode];
            const container = document.getElementById('routineScreen');
            const list = document.getElementById('routine-list');
            const title = document.getElementById('routine-title');
            const sub = document.getElementById('routine-subtitle');
            const actionBtn = document.getElementById('routine-action-btn');

            title.textContent = mode === 'warmup' ? `Warm Up (${currentWorkoutType})` : `Cool Down (${currentWorkoutType})`;
            sub.textContent = mode === 'warmup' ? "Prepare your joints" : "Restore length & relax";
            actionBtn.textContent = mode === 'warmup' ? "Start Workout" : "Finish & Home";
            
            list.innerHTML = '';
            routineData.forEach((item, idx) => {
                const detailId = `routine-detail-${idx}`;
                let detailsHtml = item.customContent || `<ol class="list-decimal list-inside text-sm text-gray-300 space-y-2 pl-2">${item.steps.map(step => `<li>${step}</li>`).join('')}</ol>`;

                const div = document.createElement('div');
                div.className = "bg-gray-800 p-4 rounded-xl";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <label class="relative flex items-center justify-center w-8 h-8 cursor-pointer">
                            <input type="checkbox" class="peer appearance-none w-8 h-8 border-2 border-gray-600 rounded-lg checked:bg-blue-600 checked:border-blue-600 routine-check">
                            <div class="hidden peer-checked:block text-white pointer-events-none"><i class="ph ph-check text-xl"></i></div>
                        </label>
                        <div class="flex-1">
                            <h4 class="font-bold text-white text-lg">${item.name}</h4>
                            <p class="text-sm text-gray-400">${item.reps} â€¢ ${item.note}</p>
                        </div>
                        <button onclick="toggleRoutineDetails('${detailId}')" class="text-blue-400 hover:text-white p-2"><i class="ph ph-eye text-xl"></i></button>
                    </div>
                    <div id="${detailId}" class="routine-details">
                        <img src="${item.image}" class="w-full h-48 object-cover rounded-lg mb-4 border border-gray-700" alt="${item.name}">
                        ${detailsHtml}
                    </div>
                `;
                list.appendChild(div);
            });

            actionBtn.onclick = () => {
                if (mode === 'warmup') window.startWorkout();
                else finishSession();
            };

            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            container.style.display = 'flex';
        }

        window.skipRoutine = () => {
            if (currentRoutineMode === 'warmup') window.startWorkout();
            else finishSession();
        }

        // --- WORKOUT LOGIC ---
        window.startWorkout = () => {
            currentExerciseIndex = 0;
            currentSessionLogs = {};
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('workoutScreen').style.display = 'flex';
            renderExercise();
        }

        async function renderExercise() {
            const ex = workouts[currentWorkoutType][currentExerciseIndex];
            document.getElementById('exercise-name').textContent = ex.name;
            document.getElementById('exercise-counter').textContent = `EXERCISE ${currentExerciseIndex + 1}/${workouts[currentWorkoutType].length}`;
            
            document.getElementById('reps-input').value = '';
            
            const list = document.getElementById('todays-sets-list');
            list.innerHTML = '';
            if (currentSessionLogs[ex.id]) {
                currentSessionLogs[ex.id].forEach(set => {
                    const div = document.createElement('div');
                    div.className = "bg-gray-800 p-3 rounded-lg border border-gray-700 flex justify-between items-center";
                    div.innerHTML = `<span class="font-bold text-white">${set.weight}kg x ${set.reps}</span> <span class="text-xs text-gray-500">RPE ${set.rpe}</span>`;
                    list.prepend(div);
                });
            }

            document.getElementById('last-log-display').textContent = 'Fetching history...';
            
            // Auto-fill logic
            let currentWeight = 0;
            if (currentSessionLogs[ex.id] && currentSessionLogs[ex.id].length > 0) {
                currentWeight = currentSessionLogs[ex.id][currentSessionLogs[ex.id].length - 1].weight;
            }
            
            document.getElementById('prev-exercise-btn').disabled = currentExerciseIndex === 0;
            document.getElementById('next-exercise-btn').innerHTML = currentExerciseIndex === workouts[currentWorkoutType].length - 1 ? 
                'Finish <i class="ph ph-check"></i>' : 'Next <i class="ph ph-caret-right"></i>';

            // Use LocalDB instead of Firestore
            const history = LocalDB.getLogsByExercise(ex.id);
            if (history.length > 0) {
                // Sort by date (descending)
                history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const last = history[0];
                document.getElementById('last-log-display').textContent = `Last: ${last.weight}kg x ${last.reps} (RPE ${last.rpe || '-'})`;
                
                if (currentWeight === 0) {
                    document.getElementById('weight-input').value = last.weight;
                } else {
                    document.getElementById('weight-input').value = currentWeight;
                }
            } else {
                document.getElementById('last-log-display').textContent = 'First time doing this!';
                if (currentWeight === 0) document.getElementById('weight-input').value = '';
            }
        }

        window.logSet = () => {
            const weight = parseFloat(document.getElementById('weight-input').value);
            const reps = parseInt(document.getElementById('reps-input').value);
            const rpe = parseInt(document.getElementById('rpe-input').value);

            if ((!weight && weight !== 0) || !reps) { window.showAlert("Please enter weight and reps."); return; }

            const ex = workouts[currentWorkoutType][currentExerciseIndex];
            
            if (!currentSessionLogs[ex.id]) currentSessionLogs[ex.id] = [];
            currentSessionLogs[ex.id].push({weight, reps, rpe});

            const div = document.createElement('div');
            div.className = "bg-gray-800 p-3 rounded-lg border border-gray-700 flex justify-between items-center animate-pulse";
            div.innerHTML = `<span class="font-bold text-white">${weight}kg x ${reps}</span> <span class="text-xs text-gray-500">RPE ${rpe}</span>`;
            document.getElementById('todays-sets-list').prepend(div);
            setTimeout(() => div.classList.remove('animate-pulse'), 500);

            // Use LocalDB
            LocalDB.addLog({
                exerciseId: ex.id,
                workoutType: currentWorkoutType,
                weight, reps, rpe
            });

            window.startRestTimer();
        }

        window.changeExercise = async (dir) => {
            const next = currentExerciseIndex + dir;
            if (next >= workouts[currentWorkoutType].length) {
                if (await window.showCustomConfirm("Finish workout?")) {
                    window.stopRestTimer();
                    if (await window.showCustomConfirm("Do the Cool-down routine?")) {
                        renderRoutine('cooldown');
                    } else {
                        finishSession();
                    }
                }
            } else {
                currentExerciseIndex = next;
                renderExercise();
            }
        }
        
        function finishSession() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('homeScreen').style.display = 'flex';
        }
        
        window.showHomeScreen = async () => {
             if (await window.showCustomConfirm("Quit workout?")) {
                finishSession();
                window.stopRestTimer();
            }
        }

        window.showGuidance = () => {
            const ex = workouts[currentWorkoutType][currentExerciseIndex];
            document.getElementById('guidance-title').textContent = ex.name;
            document.getElementById('guidance-list').innerHTML = ex.guidance.map(g => `<li>${g}</li>`).join('');
            document.getElementById('gemini-cues-container').classList.add('hidden');
            window.showModal('guidanceModal');
        }

        // --- VISUALIZATION LOGIC ---
        window.showTrends = () => {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('trendsScreen').style.display = 'flex';
            
            // Populate Select
            const select = document.getElementById('chart-exercise-select');
            select.innerHTML = '';
            const allExercises = Object.values(workouts).flat();
            allExercises.forEach(ex => {
                const opt = document.createElement('option');
                opt.value = ex.id;
                opt.text = ex.name;
                select.appendChild(opt);
            });
            
            renderTrends();
        }
        
        window.updateChart = () => {
            renderTrends();
        }

        function renderTrends() {
            const logs = LocalDB.getAllLogs();
            // Calculate Stats
            const now = new Date();
            const thisMonth = logs.filter(l => {
                const d = new Date(l.timestamp);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const distinctDays = new Set(thisMonth.map(l => new Date(l.timestamp).toDateString())).size;
            document.getElementById('monthly-count').textContent = distinctDays;

            // 1. Calendar Heatmap
            const calendarEl = document.getElementById('calendar-container');
            calendarEl.innerHTML = '';
            
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            const startOffset = (firstDay === 0 ? 6 : firstDay - 1);

            for (let i = 0; i < startOffset; i++) {
                calendarEl.appendChild(document.createElement('div'));
            }

            const loggedDates = new Set(logs.map(l => new Date(l.timestamp).toLocaleDateString()));

            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.textContent = day;
                
                const dateStr = new Date(now.getFullYear(), now.getMonth(), day).toLocaleDateString();
                if (loggedDates.has(dateStr)) {
                    div.classList.add('active');
                }
                if (day === now.getDate()) {
                    div.classList.add('today');
                }
                calendarEl.appendChild(div);
            }

            // 2. Focused Line Chart
            const ctx = document.getElementById('progressChart').getContext('2d');
            const selectedId = document.getElementById('chart-exercise-select').value || 'benchPress';
            
            // Filter for selected exercise only
            const exerciseLogs = logs.filter(l => l.exerciseId === selectedId);
            
            // Process: Sort by date & take max weight per day
            exerciseLogs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Group by day to find max
            const dailyMax = {};
            exerciseLogs.forEach(log => {
                const day = new Date(log.timestamp).toDateString();
                if (!dailyMax[day] || log.weight > dailyMax[day].y) {
                    dailyMax[day] = { x: new Date(log.timestamp), y: log.weight };
                }
            });
            
            const dataPoints = Object.values(dailyMax).sort((a,b) => a.x - b.x);

            if (progressChart) progressChart.destroy();

            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Max Weight (kg)',
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#1f2937'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (ctx) => new Date(ctx[0].raw.x).toLocaleDateString()
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' },
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // --- GEMINI ---
        async function callGemini(sys, user) {
            const apiKey = LocalDB.getApiKey();
            if (!apiKey) {
                throw new Error("Missing Gemini API Key. Please add it in Settings.");
            }

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{parts:[{text:user}]}], systemInstruction: {parts:[{text:sys}]} })
                });
                if(!r.ok) throw new Error(r.statusText);
                const j = await r.json();
                if (j.candidates && j.candidates.length > 0 && j.candidates[0].content && j.candidates[0].content.parts && j.candidates[0].content.parts.length > 0) {
                    return j.candidates[0].content.parts[0].text;
                } else {
                    return "No response generated. Please try again.";
                }
            } catch(e) { throw e; }
        }

        document.getElementById('confirm-ok').onclick = () => { window.hideModal('confirmModal'); if(confirmResolve) confirmResolve(true); }
        document.getElementById('confirm-cancel').onclick = () => { window.hideModal('confirmModal'); if(confirmResolve) confirmResolve(false); }
        
        document.getElementById('get-analysis-btn').onclick = async () => {
            if (!LocalDB.getApiKey()) {
                window.showAlert("Please enter a Gemini API Key in Settings to use this feature.");
                return;
            }

            window.showModal('analysisModal');
            const el = document.getElementById('analysis-content');
            el.textContent = "";
            document.getElementById('analysis-loader').style.display = 'flex';
            
            try {
                const logs = LocalDB.getAllLogs();
                let txt = "Here is my log:\n";
                logs.forEach(log => { txt += `${log.exerciseId}: ${log.weight}kg x ${log.reps} (Date: ${log.timestamp})\n` });
                
                if (logs.length === 0) {
                     document.getElementById('analysis-loader').style.display = 'none';
                     el.textContent = "No logs found to analyze yet! Go lift something!";
                     return;
                }

                const res = await callGemini(
                    "You are an expert strength coach. Review the user's logs. Identify 1 strength (progress) and 1 weakness (stall). Give 1 actionable tip. Keep it brief and encouraging. Use markdown.",
                    txt
                );
                document.getElementById('analysis-loader').style.display = 'none';
                el.innerHTML = res.replace(/\*\*(.*?)\*\*/g, '<b class="text-blue-400">$1</b>').replace(/\n/g, '<br>');
            } catch(e) {
                document.getElementById('analysis-loader').style.display = 'none';
                el.textContent = "Could not analyze. " + e.message;
            }
        };

        document.getElementById('get-cues-btn').onclick = async () => {
            if (!LocalDB.getApiKey()) {
                window.showAlert("Please enter a Gemini API Key in Settings to use this feature.");
                return;
            }

            const ex = workouts[currentWorkoutType][currentExerciseIndex];
            const cont = document.getElementById('gemini-cues-container');
            cont.classList.remove('hidden');
            const list = document.getElementById('gemini-cues-list');
            list.innerHTML = '';
            document.getElementById('gemini-cues-loader').style.display = 'flex';
            
            try {
                const res = await callGemini(
                    "You are a strength coach. Give 3 ultra-short, punchy mental cues for the exercise provided. Format as bullet points only.",
                    `Exercise: ${ex.name}`
                );
                const items = res.split('\n').filter(l => l.includes('-') || l.includes('*'));
                list.innerHTML = items.map(i => `<li>${i.replace(/[-*]/g,'').trim()}</li>`).join('');
                document.getElementById('gemini-cues-loader').style.display = 'none';
            } catch(e) {
                list.innerHTML = `<li class="text-red-400">Error: ${e.message}</li>`;
                document.getElementById('gemini-cues-loader').style.display = 'none';
            }
        };

        // --- INIT ---
        // Ensure DOM is loaded before accessing elements
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        function initApp() {
            const loading = document.getElementById('loadingScreen');
            const home = document.getElementById('homeScreen');
            
            if (loading) loading.style.display = 'none';
            if (home) home.style.display = 'flex';
        }

    </script>
</body>
</html>